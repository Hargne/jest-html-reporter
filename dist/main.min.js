"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var fs=_interopDefault(require("fs")),path=_interopDefault(require("path")),mkdirp=_interopDefault(require("mkdirp")),xmlbuilder=_interopDefault(require("xmlbuilder")),dateformat=_interopDefault(require("dateformat")),stripAnsi=_interopDefault(require("strip-ansi"));function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var utils=createCommonjsModule(function(e){e.exports={logMessage:({type:e,msg:t,ignoreConsole:s})=>{const o={default:"[37m%s[0m",success:"[32m%s[0m",error:"[31m%s[0m"},n=o[e]?o[e]:o.default,l=`jest-html-reporter >> ${t}`;return s||console.log(n,l),{logColor:n,logMsg:l}},writeFile:({filePath:e,content:t})=>new Promise((s,o)=>{mkdirp(path.dirname(e),n=>n?o(new Error(`Something went wrong when creating the folder: ${n}`)):fs.writeFile(e,t,t=>t?o(new Error(`Something went wrong when creating the file: ${t}`)):s(e)))}),createHtmlBase:({pageTitle:e,stylesheet:t})=>{const s={html:{head:{meta:{"@charset":"utf-8"},title:{"#text":e}}}},o=t.replace(/(\r\n|\n|\r)/gm,"");return s.html.head.style={"@type":"text/css","#text":o},s.html.head.link={"@rel":"stylesheet","@type":"text/css","@href":"https://cdn.jsdelivr.net/npm/pretty-print-json@0.0/dist/pretty-print-json.css"},s.html.script={"#text":'function showHide(item){var element = document.getElementById(item); if (element.style.display === "block"){ element.style.display = "none";} else { element.style.display = "block"; }}function showHideAll(){var elements = document.getElementsByClassName("suite-consolelog-inner-group");for(let element of elements){if (element.style.display === "block"){ element.style.display = "none";} else { element.style.display = "block"; }}}function showHideSuite(tableId, consoleLogId){showHide(tableId); showHide(consoleLogId);}'},xmlbuilder.create(s)},sortAlphabetically:({a:e,b:t,reversed:s})=>!s&&e<t||s&&e>t?-1:!s&&e>t||s&&e<t?1:0}}),utils_1=utils.logMessage,utils_2=utils.writeFile,utils_3=utils.createHtmlBase,utils_4=utils.sortAlphabetically,sorting=createCommonjsModule(function(e){e.exports={sortSuiteResults:({testData:e,sortMethod:t})=>{if(t)switch(t.toLowerCase()){case"status":return(e=>{const t=[],s=[],o=[];return e.forEach(e=>{const n=[],l=[],i=[];e.testResults.forEach(e=>{"pending"===e.status?n.push(e):"failed"===e.status?l.push(e):i.push(e)}),n.length&&t.push(Object.assign({},e,{testResults:n})),l.length&&s.push(Object.assign({},e,{testResults:l})),i.length&&o.push(Object.assign({},e,{testResults:i}))}),[].concat(t,s,o)})(e);case"executiondesc":return(e=>(e&&e.sort((e,t)=>t.perfStats.end-t.perfStats.start-(e.perfStats.end-e.perfStats.start)),e))(e);case"executionasc":return(e=>(e&&e.sort((e,t)=>e.perfStats.end-e.perfStats.start-(t.perfStats.end-t.perfStats.start)),e))(e);case"titledesc":return(e=>{if(e){const t=e.sort((e,t)=>utils.sortAlphabetically({a:e.testFilePath,b:t.testFilePath,reversed:!0}));return t.forEach(e=>{e.testResults.sort((e,t)=>utils.sortAlphabetically({a:e.ancestorTitles.join(" "),b:t.ancestorTitles.join(" "),reversed:!0}))}),t}return e})(e);case"titleasc":return(e=>{if(e){const t=e.sort((e,t)=>utils.sortAlphabetically({a:e.testFilePath,b:t.testFilePath}));return t.forEach(e=>{e.testResults.sort((e,t)=>utils.sortAlphabetically({a:e.ancestorTitles.join(" "),b:t.ancestorTitles.join(" ")}))}),t}return e})(e);default:return e}return e}}}),sorting_1=sorting.sortSuiteResults;const prettyPrintJson={version:"0.0.6",toHtml:e=>{return(e=>e.replace(/&/g,"&amp;").replace(/\\"/g,"&bsol;&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"))(JSON.stringify(e,null,3)).replace(/^( *)("[^"]+": )?("[^"]*"|[\w.+-]*)?([{}[\],]*)?$/gm,(e,t,s,o,n)=>{const l={indent:t,key:s,value:o,end:n},i=["true","false"].includes(l.value),r=/^"/.test(l.value)?"<span class=json-string>":i?"<span class=json-boolean>":"<span class=json-value>";return(l.indent||"")+(l.key?"<span class=json-key>"+l.key.replace(/"([\w]+)": |(.*): /,"$1$2")+"</span>: ":"")+(l.value?r+l.value+"</span>":"")+(l.end||"")})}};"object"==typeof module&&(module.exports=prettyPrintJson),"object"==typeof window&&(window.prettyPrintJson=prettyPrintJson);var prettyPrintJson$1=Object.freeze({}),prettyPrintJson$2=prettyPrintJson$1;class ReportGenerator{constructor(e){this.config=e}generate({data:e,ignoreConsole:t}){const s=this.config.getOutputFilepath();let o=null;return this.config.shouldUseCssFile()&&(o=this.config.getStylesheetFilepath()),this.getStylesheetContent().then(t=>this.renderHtmlReport({data:e,stylesheet:t,stylesheetPath:o})).then(e=>utils.writeFile({filePath:s,content:e})).then(()=>utils.logMessage({type:"success",msg:`Report generated (${s})`,ignoreConsole:t})).catch(e=>utils.logMessage({type:"error",msg:e,ignoreConsole:t}))}getStylesheetContent(){const e=this.config.getStylesheetFilepath();return new Promise((t,s)=>{fs.readFile(e,"utf8",(o,n)=>o?s(new Error(`Could not locate the stylesheet: '${e}': ${o}`)):t(n))})}renderHtmlReport({data:e,stylesheet:t,stylesheetPath:s}){return new Promise((o,n)=>{if(!e)return n(new Error("Test data missing or malformed"));const l=this.config.getPageTitle(),i=utils.createHtmlBase({pageTitle:l,stylesheet:t,stylesheetPath:s}),r=i.ele("header");r.ele("h1",{id:"title"},l);const a=this.config.getLogo();a&&r.ele("img",{id:"logo",src:a});const c=i.ele("div",{id:"metadata-container"}),u=new Date(e.startTime);c.ele("div",{id:"timestamp"},`Start: ${dateformat(u,this.config.getDateFormat())}`),c.ele("div",{id:"summary"},`\n\t\t\t\t${e.numTotalTests} tests --\n\t\t\t\t${e.numPassedTests} passed /\n\t\t\t\t${e.numFailedTests} failed /\n\t\t\t\t${e.numPendingTests} pending\n\t\t\t`);let g=0,p=0;sorting.sortSuiteResults({testData:e.testResults,sortMethod:this.config.getSort()}).forEach(e=>{if(!e.testResults||e.testResults.length<=0)return;if(!e.testResults.find(e=>"failed"===e.status))return;const t=`suite-table-${p}`,s=`suite-consolelog-${p}`;p+=1;const o=i.ele("div",{class:"suite-info",onclick:`showHideSuite('${t}','${s}')`});o.ele("div",{class:"suite-path"},e.testFilePath);const n=(e.perfStats.end-e.perfStats.start)/1e3;o.ele("div",{class:`suite-time${n>5?" warn":""}`},`${n}s`);const l=i.ele("table",{class:"suite-table",cellspacing:"0",cellpadding:"0",id:`${t}`}),r=e.testResults.map(e=>"failed"===e.status),a=e.testResults.map(e=>e.title);if(e.testResults.forEach(e=>{if("failed"!==e.status)return;const t=l.ele("tr",{class:e.status});t.ele("td",{class:"suite"},e.ancestorTitles.join(" > "));const s=t.ele("td",{class:"test"},e.title);if(e.failureMessages&&this.config.shouldIncludeFailureMessages()){const t=s.ele("div",{class:"failureMessages"});e.failureMessages.forEach(e=>{t.ele("pre",{class:"failureMsg"},stripAnsi(e))})}t.ele("td",{class:"result"},"passed"===e.status?`${e.status} in ${e.duration/1e3}s`:e.status)}),e.console&&e.console.length>0&&this.config.shouldIncludeConsoleLog()){const t=i.ele("div",{class:"suite-consolelog",id:`${s}`});t.ele("div",{class:"suite-consolelog-header"},"Console Log").ele("button",{class:"suite-consolelog-show-hide-all",onclick:"showHideAll()"},stripAnsi("Show/Hide All"));let o,n,l=0,c=!1;e.console.forEach(e=>{if("*** test started ***"!==e.message||r[l]||(c=!0,l+=1),!c){if(e.message.includes("*** test started ***")||e.message.includes("*** test ended ***")){return void t.ele("div",{class:"suite-consolelog-test"}).ele("pre",{class:"suite-consolelog-item-message"},stripAnsi(`${e.message}: ${a[l]}`))}if(e.message.includes("URL: ")){o=t.ele("div",{class:"suite-consolelog-group"});const s=`item-message-${g}`;return o.ele("pre",{class:"suite-consolelog-group-show-hide",onclick:`showHide('${s}')`},stripAnsi(e.message)),n=o.ele("div",{class:"suite-consolelog-inner-group",id:`${s}`}),void(g+=1)}if(n){const t=n.ele("div",{class:"suite-consolelog-item"}).ele("pre");let s;try{s=JSON.parse(e.message)}catch(e){}s?t.raw(prettyPrintJson$2.toHtml(s||e.message)):t.ele("pre",{class:"suite-consolelog-item-message"},e.message)}else{t.ele("div",{class:"suite-consolelog-item"}).ele("pre",{class:"suite-consolelog-item-message"},stripAnsi(e.message))}}"*** test ended ***"===e.message&&r[l]&&(c=!1)})}});const d=this.config.getCustomScriptFilepath();return d&&i.raw(`<script src="${d}"><\/script>`),i.raw('<script src="https://cdn.jsdelivr.net/npm/pretty-print-json@0.0/dist/pretty-print-json.min.js"><\/script>'),o(i)})}}var reportGenerator=ReportGenerator,config_1=createCommonjsModule(function(e){const t={},s=e=>Object.assign(t,e),o=()=>process.env.JEST_HTML_REPORTER_THEME||t.theme||"defaultTheme";e.exports={config:t,setup:()=>{try{const e=fs.readFileSync(path.join(process.cwd(),"jesthtmlreporter.config.json"),"utf8");if(e)return s(JSON.parse(e))}catch(e){}try{const e=fs.readFileSync(path.join(process.cwd(),"package.json"),"utf8");if(e)return s(JSON.parse(e)["jest-html-reporter"])}catch(e){}return t},setConfigData:s,getOutputFilepath:()=>process.env.JEST_HTML_REPORTER_OUTPUT_PATH||t.outputPath||path.join(process.cwd(),"test-report.html"),getStylesheetFilepath:()=>process.env.JEST_HTML_REPORTER_STYLE_OVERRIDE_PATH||t.styleOverridePath||path.join(__dirname,`../style/${o()}.css`),getCustomScriptFilepath:()=>process.env.JEST_HTML_REPORTER_CUSTOM_SCRIPT_PATH||t.customScriptPath||null,getPageTitle:()=>process.env.JEST_HTML_REPORTER_PAGE_TITLE||t.pageTitle||"Test report",getLogo:()=>process.env.JEST_HTML_REPORTER_LOGO||t.logo||null,shouldIncludeFailureMessages:()=>process.env.JEST_HTML_REPORTER_INCLUDE_FAILURE_MSG||t.includeFailureMsg||!1,shouldIncludeConsoleLog:()=>process.env.JEST_HTML_REPORTER_INCLUDE_CONSOLE_LOG||t.includeConsoleLog||!1,shouldUseCssFile:()=>process.env.JEST_HTML_REPORTER_USE_CSS_FILE||t.useCssFile||!1,getExecutionTimeWarningThreshold:()=>process.env.JEST_HTML_REPORTER_EXECUTION_TIME_WARNING_THRESHOLD||t.executionTimeWarningThreshold||5,getTheme:o,getDateFormat:()=>process.env.JEST_HTML_REPORTER_DATE_FORMAT||t.dateFormat||"yyyy-mm-dd HH:MM:ss",getSort:()=>process.env.JEST_HTML_REPORTER_SORT||t.sort||"default"}}),config_2=config_1.config,config_3=config_1.setup,config_4=config_1.setConfigData,config_5=config_1.getOutputFilepath,config_6=config_1.getStylesheetFilepath,config_7=config_1.getCustomScriptFilepath,config_8=config_1.getPageTitle,config_9=config_1.getLogo,config_10=config_1.shouldIncludeFailureMessages,config_11=config_1.shouldIncludeConsoleLog,config_12=config_1.shouldUseCssFile,config_13=config_1.getExecutionTimeWarningThreshold,config_14=config_1.getTheme,config_15=config_1.getDateFormat,config_16=config_1.getSort;function JestHtmlReporter(e,t){config_1.setup();const s=new reportGenerator(config_1);if(Object.prototype.hasOwnProperty.call(e,"testResults"))return s.generate({data:e}),e;this.jestConfig=e,this.jestOptions=t,this.onRunComplete=((e,t)=>(config_1.setConfigData(this.jestOptions),s.config=config_1,s.generate({data:t})))}var src=JestHtmlReporter;module.exports=src;
